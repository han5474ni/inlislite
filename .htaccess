# INLISLite v3.0 - Main .htaccess Configuration

# Redirect to public folder
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ public/$1 [L]

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# Protect sensitive directories
<DirectoryMatch "^.*(app|writable|tests|vendor).*$">
    Require all denied
</DirectoryMatch>

# Allow access to organized directories
<Directory "docs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

<Directory "demo">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

<Directory "setup">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
    # Restrict setup access in production
    # Require ip 127.0.0.1
    # Require ip ::1
</Directory>

<Directory "testing">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
    # Restrict testing access in production
    # Require ip 127.0.0.1
    # Require ip ::1
</Directory>

<Directory "tools">
    Options Indexes FollowSymLinks
    AllowOverride None
    # Restrict tools access - admin only
    Require ip 127.0.0.1
    Require ip ::1
</Directory>

# Protect database directory
<Directory "database">
    Require all denied
</Directory>

# Protect archive directory
<Directory "archive">
    Require all denied
</Directory>

# File type restrictions
<FilesMatch "\.(md|sql|php)$">
    <RequireAll>
        Require all granted
        # Allow markdown files for documentation
        <FilesMatch "\.md$">
            Require all granted
        </FilesMatch>
        # Restrict SQL files
        <FilesMatch "\.sql$">
            Require all denied
        </FilesMatch>
        # Allow PHP files in specific directories
        <FilesMatch "\.php$">
            <RequireAny>
                Require expr %{REQUEST_URI} =~ m#^/(demo|setup|testing)/#
                Require ip 127.0.0.1
                Require ip ::1
            </RequireAny>
        </FilesMatch>
    </RequireAll>
</FilesMatch>

# Cache control for static files
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Prevent access to sensitive files
<FilesMatch "^(\.env|\.git|composer\.(json|lock)|\.htaccess)$">
    Require all denied
</FilesMatch>

# Custom error pages
ErrorDocument 403 /public/errors/403.html
ErrorDocument 404 /public/errors/404.html
ErrorDocument 500 /public/errors/500.html